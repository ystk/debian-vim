From 8ecfa2c56b4992c7f067b92488aa9acea5a454ad Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Wed, 21 Sep 2022 13:07:22 +0100
Subject: [PATCH] patch 9.0.0530: using freed memory when autocmd changes mark

Problem:    Using freed memory when autocmd changes mark.
Solution:   Copy the mark before editing another buffer.
---
 src/mark.c                 | 12 +++++++-----
 src/testdir/test_marks.vim | 13 +++++++++++++
 src/version.c              |  2 ++
 3 files changed, 22 insertions(+), 5 deletions(-)

diff --git a/src/mark.c b/src/mark.c
index ade5a1087b7d..584db033d3ca 100644
--- a/src/mark.c
+++ b/src/mark.c
@@ -252,17 +252,19 @@ movemark(int count)
 	    fname2fnum(jmp);
 	if (jmp->fmark.fnum != curbuf->b_fnum)
 	{
-	    /* jump to other file */
-	    if (buflist_findnr(jmp->fmark.fnum) == NULL)
+	    /* Make a copy, an autocommand may make "jmp" invalid. */
+	    fmark_T fmark = jmp->fmark;
+
+	    /* jump to the file with the mark */
+	    if (buflist_findnr(fmark.fnum) == NULL)
 	    {					     /* Skip this one .. */
 		count += count < 0 ? -1 : 1;
 		continue;
 	    }
-	    if (buflist_getfile(jmp->fmark.fnum, jmp->fmark.mark.lnum,
-							    0, FALSE) == FAIL)
+	    if (buflist_getfile(fmark.fnum, fmark.mark.lnum, 0, FALSE) == FAIL)
 		return (pos_T *)NULL;
 	    /* Set lnum again, autocommands my have changed it */
-	    curwin->w_cursor = jmp->fmark.mark;
+	    curwin->w_cursor = fmark.mark;
 	    pos = (pos_T *)-1;
 	}
 	else
diff --git a/src/testdir/test_marks.vim b/src/testdir/test_marks.vim
index 12501a3aba07..20fb3041f244 100644
--- /dev/null
+++ b/src/testdir/test_marks.in
@@ -0,0 +0,16 @@
+This was using freed memory
+
+STARTTEST
+:next 00
+:edit 0
+:sargument
+:au BufEnter 0 all
+:sil norm 
+:au! BufEnter
+:bwipe!
+:norm oresult
+:/^result/,$w! test.out
+:qa!
+ENDTEST
+
+discarded
--- /dev/null
+++ b/src/testdir/test_marks.ok
@@ -0,0 +0,1 @@
+result
--- a/src/testdir/Makefile
+++ b/src/testdir/Makefile
@@ -43,6 +43,7 @@
 		test_listlbr.out \
 		test_listlbr_utf8.out \
 		test_mapping.out \
+		test_marks.out \
 		test_options.out \
 		test_qf_title.out \
 		test_signs.out \
--- a/src/version.c
+++ b/src/version.c
@@ -1198,6 +1198,8 @@
 static char *(extra_patches[]) =
 {   /* Add your patch description below this line */
 /**/
+    "9.0.0530",
+/**/
     "9.0.0490",
 /**/
     "8.2.5126",
