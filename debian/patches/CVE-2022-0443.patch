From: Markus Koschany <apo@debian.org>
Date: Tue, 17 May 2022 14:53:48 +0200
Subject: CVE-2022-0443

Origin: https://github.com/vim/vim/commit/9b4a80a66544f2782040b641498754bcb5b8d461
---
 src/buffer.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/src/buffer.c b/src/buffer.c
index 14bad8d..e2f4aa1 100644
--- a/src/buffer.c
+++ b/src/buffer.c
@@ -1456,6 +1456,7 @@ set_curbuf(buf, action)
 #ifdef FEAT_SYN_HL
     long	old_tw = curbuf->b_p_tw;
 #endif
+    int		valid;
 
     setpcmark();
     if (!cmdmod.keepalt)
@@ -1511,7 +1512,8 @@ set_curbuf(buf, action)
     /* An autocommand may have deleted "buf", already entered it (e.g., when
      * it did ":bunload") or aborted the script processing!
      * If curwin->w_buffer is null, enter_buffer() will make it valid again */
-    if ((buf_valid(buf) && buf != curbuf
+    valid = buf_valid(buf);
+    if ((valid && buf != curbuf
 # ifdef FEAT_EVAL
 	    && !aborting()
 # endif
@@ -1521,7 +1523,12 @@ set_curbuf(buf, action)
        )
 #endif
     {
-	enter_buffer(buf);
+	// If the buffer is not valid but curwin->w_buffer is NULL we must
+	// enter some buffer.  Using the last one is hopefully OK.
+	if (!valid)
+	    enter_buffer(lastbuf);
+	else
+	    enter_buffer(buf);
 #ifdef FEAT_SYN_HL
 	if (old_tw != curbuf->b_p_tw)
 	    check_colorcolumn(curwin);
