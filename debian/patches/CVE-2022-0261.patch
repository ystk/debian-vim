From: Markus Koschany <apo@debian.org>
Date: Tue, 17 May 2022 14:37:50 +0200
Subject: CVE-2022-0261

https://github.com/vim/vim/commit/9f8c304c8a390ade133bac29963dc8e56ab14cbc
---
 src/ops.c | 40 +++++++++++++++++++++++++---------------
 1 file changed, 25 insertions(+), 15 deletions(-)

--- a/src/ops.c
+++ b/src/ops.c
@@ -621,20 +621,23 @@ block_insert(oap, s, b_insert, bdp)
 	    }
 	    else
 	    {
-		int off = (*mb_off_next)(oldp, oldp + offset);
-		offset += off;
-		spaces = 0;
-		count = 0;
+		// spaces fill the gap, the character that's at the edge moves
+		// right
+		int off = (*mb_head_off)(oldp, oldp + offset + spaces);
+		offset -= off;
 	    }
 	}
 #endif
 
-	newp = alloc_check((unsigned)(STRLEN(oldp)) + s_len + count + 1);
+	// Make sure the allocated size matches what is actually copied below.
+	newp = alloc_check((unsigned)(STRLEN(oldp)) + spaces + s_len
+		    + (spaces > 0 && !bdp->is_short ? p_ts - spaces : 0)
+								  + count + 1);
 	if (newp == NULL)
 	    continue;
 
 	/* copy up to shifted part */
-	mch_memmove(newp, oldp, (size_t)(offset));
+	mch_memmove(newp, oldp, (size_t)offset);
 	oldp += offset;
 
 	/* insert pre-padding */
@@ -644,14 +647,21 @@ block_insert(oap, s, b_insert, bdp)
 	mch_memmove(newp + offset + spaces, s, (size_t)s_len);
 	offset += s_len;
 
-	if (spaces && !bdp->is_short)
+	if (spaces > 0 && !bdp->is_short)
 	{
-	    /* insert post-padding */
-	    copy_spaces(newp + offset + spaces, (size_t)(p_ts - spaces));
-	    /* We're splitting a TAB, don't copy it. */
-	    oldp++;
-	    /* We allowed for that TAB, remember this now */
-	    count++;
+	    if (*oldp == TAB)
+	    {
+		// insert post-padding
+		vim_memset(newp + offset + spaces, ' ',
+						    (size_t)(p_ts - spaces));
+		// we're splitting a TAB, don't copy it
+		oldp++;
+		// We allowed for that TAB, remember this now
+		count++;
+	    }
+	    else
+		// Not a TAB, no extra spaces
+		count = spaces;
 	}
 
 	if (spaces > 0)
@@ -2649,9 +2659,9 @@ op_insert(oap, count1)
 		oap->start_vcol = getviscol2(oap->start.col, oap->start.coladd);
 	    }
 	    else if (oap->op_type == OP_APPEND
-		      && oap->end.col
+		      && oap->start.col
 #ifdef FEAT_VIRTUALEDIT
-			    + oap->end.coladd
+			    + oap->start.coladd
 #endif
 			>= curbuf->b_op_start_orig.col
 #ifdef FEAT_VIRTUALEDIT
