From: Markus Koschany <apo@debian.org>
Date: Wed, 21 Jun 2022 11:20:44 +0200
Subject: CVE-2022-1968

Origin: https://github.com/vim/vim/commit/409510c588b1eec1ae33511ae97a21eb8e110895
---
 src/search.c | 21 ++++++++++++++++++---
 1 file changed, 18 insertions(+), 3 deletions(-)

--- a/src/search.c
+++ b/src/search.c
@@ -4656,6 +4656,21 @@ linewhite(lnum)
 #endif
 
 #if defined(FEAT_FIND_ID) || defined(PROTO)
+
+/*
+ * Get line "lnum" and copy it into "buf[LSIZE]".
+ * The copy is made because the regexp may make the line invalid when using a
+ * mark.
+ */
+    static char_u *
+get_line_and_copy(linenr_T lnum, char_u *buf)
+{
+    char_u *line = ml_get(lnum);
+
+    vim_strncpy(buf, line, LSIZE - 1);
+    return buf;
+}
+
 /*
  * Find identifiers or defines in included files.
  * If p_ic && (compl_cont_status & CONT_SOL) then ptr must be in lowercase.
@@ -4763,7 +4778,7 @@ find_pattern_in_path(ptr, dir, len, whol
 	end_lnum = curbuf->b_ml.ml_line_count;
     if (lnum > end_lnum)		/* do at least one line */
 	lnum = end_lnum;
-    line = ml_get(lnum);
+    line = get_line_and_copy(lnum, file_line);
 
     for (;;)
     {
@@ -5102,7 +5117,7 @@ search_line:
 		    {
 			if (lnum >= end_lnum)
 			    goto exit_matched;
-			line = ml_get(++lnum);
+			line = get_line_and_copy(++lnum, file_line);
 		    }
 		    else if (vim_fgets(line = file_line,
 						      LSIZE, files[depth].fp))
@@ -5316,7 +5331,7 @@ exit_matched:
 	{
 	    if (++lnum > end_lnum)
 		break;
-	    line = ml_get(lnum);
+	    line = get_line_and_copy(lnum, file_line);
 	}
 	already = NULL;
     }
