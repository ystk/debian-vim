From: Markus Koschany <apo@debian.org>
Date: Sat, 12 Mar 2022 10:05:35 +0100
Subject: CVE-2021-4193

Origin: https://github.com/vim/vim/commit/94f3192b03ed27474db80b4d3a409e107140738b
---
 src/charset.c | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/src/charset.c b/src/charset.c
index 918f9a5..d430c9e 100644
--- a/src/charset.c
+++ b/src/charset.c
@@ -1302,8 +1302,18 @@ getvcol(wp, pos, start, cursor, end)
     if (pos->col == MAXCOL)
 	posptr = NULL;  /* continue until the NUL */
     else
-	posptr = ptr + pos->col;
+    {
+	colnr_T i;
 
+	// In a few cases the position can be beyond the end of the line.
+	for (i = 0; i < pos->col; ++i)
+	    if (ptr[i] == NUL)
+	    {
+		pos->col = i;
+		break;
+	    }
+	posptr = ptr + pos->col;
+    }
     /*
      * This function is used very often, do some speed optimizations.
      * When 'list', 'linebreak', 'showbreak' and 'breakindent' are not set
