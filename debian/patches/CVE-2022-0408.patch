From: Markus Koschany <apo@debian.org>
Date: Sat, 12 Mar 2022 10:37:29 +0100
Subject: CVE-2022-0408

Origin: https://github.com/vim/vim/commit/06f15416bb8d5636200a10776f1752c4d6e49f31
---
 src/spell.c | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/src/spell.c b/src/spell.c
index af5572c..feefb1b 100644
--- a/src/spell.c
+++ b/src/spell.c
@@ -11319,7 +11319,7 @@ suggest_try_change(su)
 
 /* Check the maximum score, if we go over it we won't try this change. */
 #define TRY_DEEPER(su, stack, depth, add) \
-		(stack[depth].ts_score + (add) < su->su_maxscore)
+	   (depth < MAXWLEN && stack[depth].ts_score + (add) < su->su_maxscore)
 
 /*
  * Try finding suggestions by adding/removing/swapping letters.
@@ -11391,6 +11391,9 @@ suggest_trie_walk(su, lp, fword, soundfold)
     char_u	changename[MAXWLEN][80];
 #endif
     int		breakcheckcount = 1000;
+#ifdef FEAT_RELTIME
+    proftime_T	time_limit;
+#endif
     int		compound_ok;
 
     /*
@@ -11439,6 +11442,11 @@ suggest_trie_walk(su, lp, fword, soundfold)
 	    sp->ts_state = STATE_START;
 	}
     }
+#ifdef FEAT_RELTIME
+    // The loop may take an indefinite amount of time. Break out after five
+    // sectonds. TODO: add an option for the time limit.
+    profile_setlimit(5000, &time_limit);
+#endif
 
     /*
      * Loop to find all suggestions.  At each round we either:
@@ -12798,6 +12806,10 @@ suggest_trie_walk(su, lp, fword, soundfold)
 	    {
 		ui_breakcheck();
 		breakcheckcount = 1000;
+#ifdef FEAT_RELTIME
+		if (profile_passed_limit(&time_limit))
+		    got_int = TRUE;
+#endif
 	    }
 	}
     }
