From: Markus Koschany <apo@debian.org>
Date: Fri, 9 Jun 2023 17:36:04 +0200
Subject: CVE-2022-4141

Origin: https://github.com/vim/vim/commit/cc762a48d42b579fb7bdec2c614636b830342dd5
---
 src/normal.c         | 36 ++++++++++++++++++++++++++----------
 src/proto/normal.pro |  1 +
 src/window.c         |  4 +++-
 3 files changed, 30 insertions(+), 11 deletions(-)

diff --git a/src/normal.c b/src/normal.c
index 812c71f..b6aaea0 100644
--- a/src/normal.c
+++ b/src/normal.c
@@ -549,13 +549,36 @@ check_text_locked(oparg_T *oap)
 {
     if (text_locked())
     {
-	clearopbeep(oap);
+	if (oap != NULL)
+	    clearopbeep(oap);
 	text_locked_msg();
 	return TRUE;
     }
     return FALSE;
 }
 
+/*
+ * If text is locked, "curbuf_lock" or "allbuf_lock" is set:
+ * Give an error message, possibly beep and return TRUE.
+ * "oap" may be NULL.
+ */
+    int
+check_text_or_curbuf_locked(oparg_T *oap)
+{
+    if (check_text_locked(oap))
+	return TRUE;
+
+#ifdef FEAT_AUTOCMD
+    if (curbuf_locked())
+    {
+	if (oap != NULL)
+	    clearop(oap);
+	return TRUE;
+    }
+#endif
+    return FALSE;
+}
+
 /*
  * Execute a command in Normal mode.
  */
@@ -826,7 +849,7 @@ getcount:
 	goto normal_end;
     }
 
-    if ((nv_cmds[idx].cmd_flags & NV_NCW) && check_text_locked(oap))
+    if ((nv_cmds[idx].cmd_flags & NV_NCW) && check_text_or_curbuf_locked(oap))
     {
 	/* This command is not allowed while editing a cmdline: beep. */
 	goto normal_end;
@@ -6217,15 +6240,8 @@ nv_gotofile(cap)
     char_u	*ptr;
     linenr_T	lnum = -1;
 
-    if (check_text_locked(cap->oap))
-	return;
-#ifdef FEAT_AUTOCMD
-    if (curbuf_locked())
-    {
-	clearop(cap->oap);
+    if (check_text_or_curbuf_locked(cap->oap))
 	return;
-    }
-#endif
 
     ptr = grab_file_name(cap->count1, &lnum);
 
diff --git a/src/proto/normal.pro b/src/proto/normal.pro
index 55e8163..f12c578 100644
--- a/src/proto/normal.pro
+++ b/src/proto/normal.pro
@@ -1,4 +1,5 @@
 /* normal.c */
+int check_text_or_curbuf_locked(oparg_T *oap);
 void init_normal_cmds __ARGS((void));
 void normal_cmd __ARGS((oparg_T *oap, int toplevel));
 void do_pending_operator __ARGS((cmdarg_T *cap, int old_col, int gui_yank));
diff --git a/src/window.c b/src/window.c
index cdd7a05..218267e 100644
--- a/src/window.c
+++ b/src/window.c
@@ -501,6 +501,8 @@ newwindow:
     case Ctrl_F:
 wingotofile:
 		CHECK_CMDWIN
+		if (check_text_or_curbuf_locked(NULL))
+		    break;
 
 		ptr = grab_file_name(Prenum1, &lnum);
 		if (ptr != NULL)
@@ -669,7 +671,7 @@ win_split(size, flags)
  * When "new_wp" is NULL: split the current window in two.
  * When "new_wp" is not NULL: insert this window at the far
  * top/left/right/bottom.
- * return FAIL for failure, OK otherwise
+ * Return FAIL for failure, OK otherwise.
  */
     int
 win_split_ins(size, flags, new_wp, dir)
