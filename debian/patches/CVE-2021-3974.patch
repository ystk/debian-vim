From: Markus Koschany <apo@debian.org>
Date: Sat, 12 Mar 2022 09:59:11 +0100
Subject: CVE-2021-3974

Origin: https://github.com/vim/vim/commit/64066b9acd9f8cffdf4840f797748f938a13f2d6
---
 src/regexp.c     | 2 +-
 src/regexp_nfa.c | 8 ++++++++
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/src/regexp.c b/src/regexp.c
index f19e139..29ac6c7 100644
--- a/src/regexp.c
+++ b/src/regexp.c
@@ -3468,7 +3468,7 @@ read_limits(minval, maxval)
 /* The current match-position is remembered with these variables: */
 static linenr_T	reglnum;	/* line number, relative to first line */
 static char_u	*regline;	/* start of current line */
-static char_u	*reginput;	/* current input, points into "regline" */
+static char_u	*reginput;	/* current input, points into "line" */
 
 static int	need_clear_subexpr;	/* subexpressions still need to be
 					 * cleared */
diff --git a/src/regexp_nfa.c b/src/regexp_nfa.c
index 3763566..9aae23a 100644
--- a/src/regexp_nfa.c
+++ b/src/regexp_nfa.c
@@ -6436,8 +6436,16 @@ nfa_regmatch(prog, start, submatch, m)
 	    case NFA_MARK_GT:
 	    case NFA_MARK_LT:
 	      {
+		size_t	col = reginput - regline;
 		pos_T	*pos = getmark_buf(reg_buf, t->state->val, FALSE);
 
+		// Line may have been freed, get it again.
+		if (REG_MULTI)
+		{
+		    regline = reg_getline(reglnum);
+		    reginput = regline + col;
+		}
+
 		/* Compare the mark position to the match position. */
 		result = (pos != NULL		     /* mark doesn't exist */
 			&& pos->lnum > 0    /* mark isn't set in reg_buf */
