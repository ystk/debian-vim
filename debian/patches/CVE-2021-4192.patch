From: Markus Koschany <apo@debian.org>
Date: Sat, 12 Mar 2022 10:04:04 +0100
Subject: CVE-2021-4192

Origin: https://github.com/vim/vim/commit/4c13e5e6763c6eb36a343a2b8235ea227202e952
---
 src/regexp.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/src/regexp.c b/src/regexp.c
index 29ac6c7..6d4d3e8 100644
--- a/src/regexp.c
+++ b/src/regexp.c
@@ -4230,9 +4230,9 @@ reg_match_visual()
     if (lnum < top.lnum || lnum > bot.lnum)
 	return FALSE;
 
+    col = (colnr_T)(reginput - regline);
     if (mode == 'v')
     {
-	col = (colnr_T)(reginput - regline);
 	if ((lnum == top.lnum && col < top.col)
 		|| (lnum == bot.lnum && col >= bot.col + (*p_sel != 'e')))
 	    return FALSE;
@@ -4247,7 +4247,12 @@ reg_match_visual()
 	    end = end2;
 	if (top.col == MAXCOL || bot.col == MAXCOL)
 	    end = MAXCOL;
-	cols = win_linetabsize(wp, regline, (colnr_T)(reginput - regline));
+
+	// getvvcol() flushes rex.line, need to get it again
+	regline = reg_getline(reglnum);
+	reginput = regline + col;
+
+	cols = win_linetabsize(wp, regline, col);
 	if (cols < start || cols > end - (*p_sel == 'e'))
 	    return FALSE;
     }
