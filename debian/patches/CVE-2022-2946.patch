From: Markus Koschany <apo@debian.org>
Date: Thu, 10 Nov 2022 17:04:26 +0100
Subject: CVE-2022-2946

Origin: https://github.com/vim/vim/commit/adce965162dd89bf29ee0e5baf53652e7515762c
---
 src/tag.c | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/src/tag.c b/src/tag.c
index ba42f15..983be81 100644
--- a/src/tag.c
+++ b/src/tag.c
@@ -158,6 +158,7 @@ do_tag(tag, type, count, forceit, verbose)
     int		attr;
     int		use_tagstack;
     int		skip_msg = FALSE;
+    char_u	*tofree = NULL;
     char_u	*buf_ffname = curbuf->b_ffname;	    /* name to use for
 						       priority computation */
 
@@ -490,7 +491,12 @@ do_tag(tag, type, count, forceit, verbose)
 	 * When desired match not found yet, try to find it (and others).
 	 */
 	if (use_tagstack)
-	    name = tagstack[tagstackidx].tagname;
+	{
+	    // make a copy, the tagstack may change in 'tagfunc'
+	    name = vim_strsave(tagstack[tagstackidx].tagname);
+	    vim_free(tofree);
+	    tofree = name;
+	}
 #if defined(FEAT_WINDOWS) && defined(FEAT_QUICKFIX)
 	else if (g_do_tagpreview != 0)
 	    name = ptag_entry.tagname;
@@ -1082,6 +1088,7 @@ end_do_tag:
     postponed_split = 0;	/* don't split next time */
 #endif
 
+    vim_free(tofree);
 #ifdef FEAT_CSCOPE
     return jumped_to_tag;
 #else
