From: Markus Koschany <apo@debian.org>
Date: Tue, 17 May 2022 16:16:56 +0200
Subject: CVE-2022-1720

Origin: https://github.com/vim/vim/commit/395bd1f6d3edc9f7edb5d1f2d7deaf5a9e3ab93c
---
 src/normal.c | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

--- a/src/normal.c
+++ b/src/normal.c
@@ -5809,9 +5809,17 @@ get_visual_text(cap, pp, lenp)
 #ifdef FEAT_MBYTE
 	if (**pp == NUL)
 	    *lenp = 0;
-	if (has_mbyte && *lenp > 0)
-	    /* Correct the length to include the whole last character. */
-	    *lenp += (*mb_ptr2len)(*pp + (*lenp - 1)) - 1;
+
+	if (*lenp > 0)
+	{
+	    if (has_mbyte)
+		// Correct the length to include all bytes of the last
+		// character.
+		*lenp += (*mb_ptr2len)(*pp + (*lenp - 1)) - 1;
+	    else if ((*pp)[*lenp - 1] == NUL)
+		// Do not include a trailing NUL.
+		*lenp -= 1;
+	}
 #endif
     }
     reset_VIsual_and_resel();
