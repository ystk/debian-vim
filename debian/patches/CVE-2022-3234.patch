From: Markus Koschany <apo@debian.org>
Date: Thu, 10 Nov 2022 17:09:50 +0100
Subject: CVE-2022-3234

Origin: https://github.com/vim/vim/commit/c249913edc35c0e666d783bfc21595cf9f7d9e0d
---
 src/ops.c | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/src/ops.c b/src/ops.c
index 594b481..78ab58e 100644
--- a/src/ops.c
+++ b/src/ops.c
@@ -2230,6 +2230,8 @@ op_replace(oap, c)
 
 	while (ltoreq(curwin->w_cursor, oap->end))
 	{
+	    int done = FALSE;
+
 	    n = gchar_cursor();
 	    if (n != NUL)
 	    {
@@ -2246,6 +2248,7 @@ op_replace(oap, c)
 		    State = n;
 		    /* Backup to the replaced character. */
 		    dec_cursor();
+		    done = TRUE;
 		}
 		else
 #endif
@@ -2267,11 +2270,17 @@ op_replace(oap, c)
 			    getvpos(&oap->end, end_vcol);
 		    }
 #endif
-		    pchar(curwin->w_cursor, c);
+		    // with "coladd" set may move to just after a TAB
+		    if (gchar_cursor() != NUL)
+		    {
+			pchar(curwin->w_cursor, c);
+			done = TRUE;
+		    }
+
 		}
 	    }
 #ifdef FEAT_VIRTUALEDIT
-	    else if (virtual_op && curwin->w_cursor.lnum == oap->end.lnum)
+	    if (!done && virtual_op && curwin->w_cursor.lnum == oap->end.lnum)
 	    {
 		int virtcols = oap->end.coladd;
 
