From: Markus Koschany <apo@debian.org>
Date: Tue, 17 May 2022 15:54:30 +0200
Subject: CVE-2022-1154

Origin: https://github.com/vim/vim/commit/b55986c52d4cd88a22d0b0b0e8a79547ba13e1d5
---
 src/regexp.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/src/regexp.c b/src/regexp.c
index ab4ac86..211e99c 100644
--- a/src/regexp.c
+++ b/src/regexp.c
@@ -4421,8 +4421,16 @@ regmatch(scan)
 		int	mark = OPERAND(scan)[0];
 		int	cmp = OPERAND(scan)[1];
 		pos_T	*pos;
+		size_t	col = REG_MULTI ? reginput - regline : 0;
 
 		pos = getmark_buf(reg_buf, mark, FALSE);
+		// Line may have been freed, get it again.
+		if (REG_MULTI)
+		{
+		    regline = reg_getline(reglnum);
+		    reginput = regline + col;
+		}
+
 		if (pos == NULL		     /* mark doesn't exist */
 			|| pos->lnum <= 0    /* mark isn't set in reg_buf */
 			|| (pos->lnum == reglnum + reg_firstlnum
