From: Markus Koschany <apo@debian.org>
Date: Tue, 17 May 2022 16:03:27 +0200
Subject: CVE-2022-1616

Origin: https://github.com/vim/vim/commit/d88934406c5375d88f8f1b65331c9f0cab68cc6c
---
 src/ex_docmd.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

--- a/src/ex_docmd.c
+++ b/src/ex_docmd.c
@@ -2839,7 +2839,7 @@ append_command(cmd)
 
     STRCAT(IObuff, ": ");
     d = IObuff + STRLEN(IObuff);
-    while (*s != NUL && d - IObuff < IOSIZE - 7)
+    while (*s != NUL && d - IObuff + 5 < IOSIZE)
     {
 	if (
 #ifdef FEAT_MBYTE
@@ -2855,6 +2855,8 @@ append_command(cmd)
 	    STRCPY(d, "<a0>");
 	    d += 4;
 	}
+	else if (d - IObuff + (*mb_ptr2len)(s) + 1 >= IOSIZE)
+	    break;
 	else
 	    MB_COPY_CHAR(s, d);
     }
