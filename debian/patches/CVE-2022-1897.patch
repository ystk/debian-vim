From 338f1fc0ee3ca929387448fe464579d6113fa76a Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Thu, 26 May 2022 15:56:23 +0100
Subject: [PATCH] patch 8.2.5023: substitute overwrites allocated buffer

Problem:    Substitute overwrites allocated buffer.
Solution:   Disallow undo when in a substitute command.
---
 src/normal.c                    | 42 ++++++++++++++++-----------------
 src/testdir/test_substitute.vim | 22 +++++++++++++++++
 src/undo.c                      |  6 +++++
 src/version.c                   |  2 ++
 4 files changed, 51 insertions(+), 21 deletions(-)

Backport: drop testcase as it does not trigger the issue

diff --git a/src/normal.c b/src/normal.c
index bc3e29e1abaa..53c50dc8b368 100644
--- a/src/normal.c
+++ b/src/normal.c
@@ -533,6 +533,22 @@ find_command(int cmdchar)
     return idx;
 }
 
+/*
+ * If currently editing a cmdline or text is locked: beep and give an error
+ * message, return TRUE.
+ */
+    static int
+check_text_locked(oparg_T *oap)
+{
+    if (text_locked())
+    {
+	clearopbeep(oap);
+	text_locked_msg();
+	return TRUE;
+    }
+    return FALSE;
+}
+
 /*
  * Execute a command in Normal mode.
  */
@@ -799,11 +815,9 @@ normal_cmd(
 	goto normal_end;
     }
 
-    if (text_locked() && (nv_cmds[idx].cmd_flags & NV_NCW))
+    if ((nv_cmds[idx].cmd_flags & NV_NCW) && check_text_locked(oap))
     {
 	/* This command is not allowed while editing a cmdline: beep. */
-	clearopbeep(oap);
-	text_locked_msg();
 	goto normal_end;
     }
 #ifdef FEAT_AUTOCMD
@@ -6232,12 +6243,8 @@ nv_gotofile(cmdarg_T *cap)
     char_u	*ptr;
     linenr_T	lnum = -1;
 
-    if (text_locked())
-    {
-	clearopbeep(cap->oap);
-	text_locked_msg();
+    if (check_text_locked(cap->oap))
 	return;
-    }
 #ifdef FEAT_AUTOCMD
     if (curbuf_locked())
     {
@@ -8330,14 +8337,7 @@ nv_g_cmd(cmdarg_T *cap)
 
     /* "gQ": improved Ex mode */
     case 'Q':
-	if (text_locked())
-	{
-	    clearopbeep(cap->oap);
-	    text_locked_msg();
-	    break;
-	}
-
-	if (!checkclearopq(oap))
+	if (!check_text_locked(cap->oap) && !checkclearopq(oap))
 	    do_exmode(TRUE);
 	break;
 
diff --git a/src/undo.c b/src/undo.c
index cac09f0f58df..81cc28e8b801 100644
--- a/src/undo.c
+++ b/src/undo.c
@@ -2278,6 +2278,12 @@ undo_time(
     int		    above = FALSE;
     int		    did_undo = TRUE;
 
+    if (text_locked())
+    {
+	text_locked_msg();
+	return;
+    }
+
     /* First make sure the current undoable change is synced. */
     if (curbuf->b_u_synced == FALSE)
 	u_sync(TRUE);
diff --git a/src/version.c b/src/version.c
index 9751865c7adf..cd6c33162204 100644
--- a/src/version.c
+++ b/src/version.c
@@ -1733,6 +1733,8 @@
 static char *(extra_patches[]) =
 {   /* Add your patch description below this line */
 /**/
+    "8.2.5023",
+/**/
     "8.2.4977",
 /**/
     "8.1.1365",
