From: Markus Koschany <apo@debian.org>
Date: Sat, 12 Mar 2022 10:42:01 +0100
Subject: CVE-2022-0554

Origin: https://github.com/vim/vim/commit/e3537aec2f8d6470010547af28dcbd83d41461b8
---
 src/buffer.c | 26 ++++++++++++++++++++++----
 1 file changed, 22 insertions(+), 4 deletions(-)

--- a/src/buffer.c
+++ b/src/buffer.c
@@ -1276,8 +1276,14 @@ do_buffer(action, start, dir, count, for
 		buf = buflist_findnr(curwin->w_jumplist[jumpidx].fmark.fnum);
 		if (buf != NULL)
 		{
-		    if (buf == curbuf || !buf->b_p_bl)
-			buf = NULL;	/* skip current and unlisted bufs */
+		    // Skip current and unlisted bufs.  Also skip a quickfix
+		    // buffer, it might be deleted soon.
+		    if (buf == curbuf || !buf->b_p_bl
+#if defined(FEAT_QUICKFIX)
+			    || bt_quickfix(buf)
+#endif
+			    )
+			buf = NULL;
 		    else if (buf->b_ml.ml_mfp == NULL)
 		    {
 			/* skip unloaded buf, but may keep it for later */
@@ -1314,7 +1320,11 @@ do_buffer(action, start, dir, count, for
 		    continue;
 		}
 		/* in non-help buffer, try to skip help buffers, and vv */
-		if (buf->b_help == curbuf->b_help && buf->b_p_bl)
+		if (buf->b_help == curbuf->b_help && buf->b_p_bl
+#if defined(FEAT_QUICKFIX)
+			    && !bt_quickfix(buf)
+#endif
+			   )
 		{
 		    if (buf->b_ml.ml_mfp != NULL)   /* found loaded buffer */
 			break;
@@ -1332,7 +1342,11 @@ do_buffer(action, start, dir, count, for
 	if (buf == NULL)	/* No loaded buffer, find listed one */
 	{
 	    for (buf = firstbuf; buf != NULL; buf = buf->b_next)
-		if (buf->b_p_bl && buf != curbuf)
+		if (buf->b_p_bl && buf != curbuf
+#if defined(FEAT_QUICKFIX)
+			    && !bt_quickfix(buf)
+#endif
+		    )
 		    break;
 	}
 	if (buf == NULL)	/* Still no buffer, just take one */
@@ -1341,6 +1355,10 @@ do_buffer(action, start, dir, count, for
 		buf = curbuf->b_next;
 	    else
 		buf = curbuf->b_prev;
+#if defined(FEAT_QUICKFIX)
+	    if (bt_quickfix(buf))
+		buf = NULL;
+#endif
 	}
     }
 
