From 44a3f3353e0407e9fffee138125a6927d1c9e7e5 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Mon, 6 Jun 2022 15:38:21 +0100
Subject: [PATCH] patch 8.2.5063: error for a command may go over the end of
 IObuff

Problem:    Error for a command may go over the end of IObuff.
Solution:   Truncate the message.
---
 src/ex_docmd.c               | 12 ++++++++++--
 src/testdir/test_cmdline.vim |  5 +++++
 src/version.c                |  2 ++
 3 files changed, 17 insertions(+), 2 deletions(-)

--- a/src/ex_docmd.c
+++ b/src/ex_docmd.c
@@ -2834,9 +2834,17 @@ checkforcmd(pp, cmd, len)
 append_command(cmd)
     char_u *cmd;
 {
+    size_t  len = STRLEN(IObuff);
     char_u *s = cmd;
     char_u *d;
 
+    if (len > IOSIZE - 100)
+    {
+	// Not enough space, truncate and put in "...".
+	d = IObuff + IOSIZE - 100;
+	d -= mb_head_off(IObuff, d);
+	STRCPY(d, "...");
+    }
     STRCAT(IObuff, ": ");
     d = IObuff + STRLEN(IObuff);
     while (*s != NUL && d - IObuff + 5 < IOSIZE)
--- /dev/null
+++ b/src/testdir/test_cmdline.in
@@ -0,0 +1,12 @@
+Test long error message
+
+STARTTEST
+:so small.vim
+:set encoding=utf-8
+: " the error should be truncated, not overrun IObuff
+:silent! norm Q00000000000000     000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000                                                                                                                                                                                                                        
+:/^result/,$w! test.out
+:qa!
+ENDTEST
+
+result
--- /dev/null
+++ b/src/testdir/test_cmdline.ok
@@ -0,0 +1 @@
+result
--- a/src/testdir/Makefile
+++ b/src/testdir/Makefile
@@ -36,6 +36,7 @@ SCRIPTS = test1.out test2.out test3.out
 		test_autoformat_join.out \
 		test_breakindent.out \
 		test_changelist.out \
+		test_cmdline.out \
 		test_eval.out \
 		test_insertcount.out \
 		test_listlbr.out \
--- a/src/version.c
+++ b/src/version.c
@@ -1733,6 +1733,8 @@ static int included_patches[] =
 static char *(extra_patches[]) =
 {   /* Add your patch description below this line */
 /**/
+    "8.2.5063",
+/**/
     "8.2.5043",
 /**/
     "8.2.5023",
