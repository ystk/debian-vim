From d6211a52ab9f53b82f884561ed43d2fe4d24ff7d Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Sat, 18 Jun 2022 19:48:14 +0100
Subject: [PATCH] patch 8.2.5126: substitute may overrun destination buffer

Problem:    Substitute may overrun destination buffer.
Solution:   Disallow switching buffers in a substitute expression.
---
 src/ex_docmd.c                  |  7 ++++---
 src/testdir/test_substitute.vim | 13 +++++++++++++
 src/version.c                   |  2 ++
 3 files changed, 19 insertions(+), 3 deletions(-)

Backport: Drop testcase, because substituting \%') does not work in vim 7.x.

--- a/src/ex_docmd.c
+++ b/src/ex_docmd.c
@@ -7932,9 +7932,10 @@ do_exedit(eap, old_curwin)
 	    )
     {
 #ifdef FEAT_AUTOCMD
-	/* Can't edit another file when "curbuf_lock" is set.  Only ":edit"
-	 * can bring us here, others are stopped earlier. */
-	if (*eap->arg != NUL && curbuf_locked())
+	/* Can't edit another file when "textlock" or "curbuf_lock" is set.
+	 * Only ":edit" or ":script" can bring us here, others are stopped
+	   earlier. */
+	if (*eap->arg != NUL && text_or_buf_locked())
 	    return;
 #endif
 	n = readonlymode;
--- a/src/version.c
+++ b/src/version.c
@@ -1733,6 +1733,8 @@ static int included_patches[] =
 static char *(extra_patches[]) =
 {   /* Add your patch description below this line */
 /**/
+    "8.2.5126",
+/**/
     "8.2.5063",
 /**/
     "8.2.5043",
