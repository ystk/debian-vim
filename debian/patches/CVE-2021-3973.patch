From: Markus Koschany <apo@debian.org>
Date: Sat, 12 Mar 2022 09:56:40 +0100
Subject: CVE-2021-3973

Origin: https://github.com/vim/vim/commit/615ddd5342b50a6878a907062aa471740bd9a847
---
 src/misc2.c  | 3 +++
 src/normal.c | 4 +++-
 2 files changed, 6 insertions(+), 1 deletion(-)

--- a/src/misc2.c
+++ b/src/misc2.c
@@ -5515,6 +5515,9 @@ find_file_in_path_option(ptr, len, optio
     proc->pr_WindowPtr = (APTR)-1L;
 #endif
 
+    if (len == 0)
+	return NULL;
+
     if (first == TRUE)
     {
 	/* copy file name into NameBuff, expanding environment variables */
--- a/src/normal.c
+++ b/src/normal.c
@@ -5807,7 +5807,9 @@ get_visual_text(cap, pp, lenp)
 	    *lenp = curwin->w_cursor.col - VIsual.col + 1;
 	}
 #ifdef FEAT_MBYTE
-	if (has_mbyte)
+	if (**pp == NUL)
+	    *lenp = 0;
+	if (has_mbyte && *lenp > 0)
 	    /* Correct the length to include the whole last character. */
 	    *lenp += (*mb_ptr2len)(*pp + (*lenp - 1)) - 1;
 #endif
