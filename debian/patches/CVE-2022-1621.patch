From: Markus Koschany <apo@debian.org>
Date: Tue, 17 May 2022 16:04:47 +0200
Subject: CVE-2022-1621

Origin: https://github.com/vim/vim/commit/7c824682d2028432ee082703ef0ab399867a089b
---
 src/mbyte.c | 2 +-
 src/spell.c | 9 +++++++++
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/src/mbyte.c b/src/mbyte.c
index 44cbd5f..98b827b 100644
--- a/src/mbyte.c
+++ b/src/mbyte.c
@@ -3656,7 +3656,7 @@ theend:
     convert_setup(&vimconv, NULL, NULL);
 }
 
-#if defined(FEAT_GUI_GTK) || defined(PROTO)
+#if defined(FEAT_GUI_GTK) || defined(FEAT_SPELL) || defined(PROTO)
 /*
  * Return TRUE if string "s" is a valid utf-8 string.
  * When "end" is NULL stop at the first NUL.
diff --git a/src/spell.c b/src/spell.c
index feefb1b..41f25e6 100644
--- a/src/spell.c
+++ b/src/spell.c
@@ -7479,6 +7479,10 @@ store_word(spin, word, flags, region, pfxlist, need_affix)
     int		res = OK;
     char_u	*p;
 
+    // Avoid adding illegal bytes to the word tree.
+    if (enc_utf8 && !utf_valid_string(word, NULL))
+	return FAIL;
+
     (void)spell_casefold(word, len, foldword, MAXWLEN);
     for (p = pfxlist; res == OK; ++p)
     {
@@ -9429,6 +9433,11 @@ spell_add_word(word, len, bad, idx, undo)
     int		i;
     char_u	*spf;
 
+    if (enc_utf8 && !utf_valid_string(word, NULL))
+    {
+	return;
+    }
+
     if (idx == 0)	    /* use internal wordlist */
     {
 	if (int_wordlist == NULL)
