From 71223e2db87c2bf3b09aecb46266b56cda26191d Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Mon, 30 May 2022 15:23:09 +0100
Subject: [PATCH] patch 8.2.5043: can open a cmdline window from a substitute
 expression

Problem:    Can open a cmdline window from a substitute expression.
Solution:   Disallow opening a command line window when text or buffer is
            locked.
---
 src/buffer.c                    |  7 +------
 src/ex_getln.c                  | 19 +++++++++++++++++++
 src/proto/ex_getln.pro          |  5 +++--
 src/testdir/test_substitute.vim | 25 +++++++++++++++++++++++++
 src/version.c                   |  2 ++
 src/window.c                    |  5 +----
 6 files changed, 51 insertions(+), 12 deletions(-)

Backport: Drop test case, because the expected E565 was only introduced in
 8.2.0670 and the testcase does not otherwise fail or issue messages in
 valgrind. Also deal with FEAT_AUTOCMD disabling curbuf_locked().

--- a/src/buffer.c
+++ b/src/buffer.c
@@ -2067,15 +2067,8 @@ buflist_getfile(n, lnum, options, forcei
     if (buf == curbuf)
 	return OK;
 
-    if (text_locked())
-    {
-	text_locked_msg();
+    if (text_or_buf_locked())
 	return FAIL;
-    }
-#ifdef FEAT_AUTOCMD
-    if (curbuf_locked())
-	return FAIL;
-#endif
 
     /* altfpos may be changed by getfile(), get it now */
     if (lnum == 0)
--- a/src/ex_getln.c
+++ b/src/ex_getln.c
@@ -2054,6 +2054,25 @@ text_locked_msg()
 	EMSG(_(e_secure));
 }
 
+/*
+ * Check for text, window or buffer locked.
+ * Give an error message and return TRUE if something is locked.
+ */
+    int
+text_or_buf_locked(void)
+{
+    if (text_locked())
+    {
+	text_locked_msg();
+	return TRUE;
+    }
+#if defined(FEAT_AUTOCMD)
+    return curbuf_locked();
+#else
+    return FALSE;
+#endif
+}
+
 #if defined(FEAT_AUTOCMD) || defined(PROTO)
 /*
  * Check if "curbuf_lock" or "allbuf_lock" is set and return TRUE when it is
@@ -6374,6 +6393,10 @@ ex_window()
     int			save_KeyTyped;
 #endif
 
+    /* Can't do this when text or buffer is locked. */
+    if (text_or_buf_locked())
+	return K_IGNORE;
+
     /* Can't do this recursively.  Can't do it when typing a password. */
     if (cmdwin_type != 0
 # if defined(FEAT_CRYPT) || defined(FEAT_EVAL)
--- a/src/proto/ex_getln.pro
+++ b/src/proto/ex_getln.pro
@@ -3,6 +3,7 @@ char_u *getcmdline __ARGS((int firstc, l
 char_u *getcmdline_prompt __ARGS((int firstc, char_u *prompt, int attr, int xp_context, char_u *xp_arg));
 int text_locked __ARGS((void));
 void text_locked_msg __ARGS((void));
+int text_or_buf_locked __ARGS((void));
 int curbuf_locked __ARGS((void));
 int allbuf_locked __ARGS((void));
 char_u *getexline __ARGS((int c, void *cookie, int indent));
--- a/src/version.c
+++ b/src/version.c
@@ -1733,6 +1733,8 @@ static int included_patches[] =
 static char *(extra_patches[]) =
 {   /* Add your patch description below this line */
 /**/
+    "8.2.5043",
+/**/
     "8.2.5023",
 /**/
     "8.2.4977",
--- a/src/window.c
+++ b/src/window.c
@@ -4061,15 +4061,12 @@ win_goto(wp)
     win_T	*owp = curwin;
 #endif
 
-    if (text_locked())
+    if (text_or_buf_locked())
     {
 	beep_flush();
-	text_locked_msg();
 	return;
     }
 #ifdef FEAT_AUTOCMD
-    if (curbuf_locked())
-	return;
 #endif
 
     if (wp->w_buffer != curbuf)
